Bootstrap: docker
From: ubuntu:22.04

%post
    # Install Git
    apt-get update && apt-get upgrade -y && apt-get install -y build-essential make cmake curl git

    # Install Conda
    curl -O https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
    bash Miniconda3-latest-Linux-x86_64.sh -b -p /opt/conda
    rm Miniconda3-latest-Linux-x86_64.sh
    echo ". /opt/conda/etc/profile.d/conda.sh" >> ~/.bashrc
    . /opt/conda/etc/profile.d/conda.sh

    # downloading GCparagon
    mkdir /opt/github && cd /opt/github
    git clone https://github.com/BGSpiegl/GCparagon.git && cd GCparagon
    conda env create -f conda_env/GCparagon_py3.10_env.yml -y
    conda activate GCparagon
    two_bit_ref_url_hg38="https://hgdownload.soe.ucsc.edu/goldenPath/hg38/bigZips/analysisSet/hg38.analysisSet.2bit"
    two_bit_ref_url_hg19="https://hgdownload.soe.ucsc.edu/goldenPath/hg19/bigZips/hg19.2bit"
    cd src/GCparagon/2bit_reference/
    curl -O "${two_bit_ref_url_hg38}"
    curl -O "${two_bit_ref_url_hg19}"
    cd /opt/github/GCparagon
    python -m pip install .

    # move files to expected directory after installation (the gcparagon command is used below which assumes another )
    # These files are used by variables EXPECTED_TWO_BIT_REFERENCE_GENOME_PATH, PREDEFINED_1MBP_INTERVALS_TO_PROCESS,
    # and DEFAULT_REFERENCE_GENOME_TARGET_GC_CONTENT_DISTRIBUTION.
    # need paths: "/opt/conda/envs/GCparagon/lib/python3.10/site-packages/GCparagon/2bit_reference/"
    # and:        "/opt/conda/envs/GCparagon/lib/python3.10/accessory_files/"
    target_ref_files_path="/opt/conda/envs/GCparagon/lib/python3.10"
    # create if it does not exist
    if [ ! -d "${target_ref_files_path}/site-packages/GCparagon/2bit_reference/" ]; then
        mkdir -p "${target_ref_files_path}/site-packages/GCparagon/2bit_reference/"
    fi
    if [ ! -d "${target_ref_files_path}/accessory_files/" ]; then
        mkdir "${target_ref_files_path}/accessory_files/"
    fi
    # move reference genomes
    mv /opt/github/GCparagon/src/GCparagon/2bit_reference/*.2bit "${target_ref_files_path}/site-packages/GCparagon/2bit_reference/"
    mv /opt/github/GCparagon/src/GCparagon/2bit_reference/*.chrom.sizes "${target_ref_files_path}/site-packages/GCparagon/2bit_reference/"
    # move pre-selected intervals
    mv /opt/github/GCparagon/accessory_files/*_minimalExclusionListOverlap_*OverlapLimited.FGCD.bed  "${target_ref_files_path}/accessory_files/"
    # move reference GC content distributions
    mv /opt/github/GCparagon/accessory_files/*_reference_GC_content_distribution.tsv  "${target_ref_files_path}/accessory_files/"

%environment
    export PATH=/opt/conda/bin:$PATH

%runscript
    . /opt/conda/etc/profile.d/conda.sh
    conda activate GCparagon
    exec gcparagon "$@"